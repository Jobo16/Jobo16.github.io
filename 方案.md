# 团队静态页面托管平台重构方案

## 0. 当前进度

1. 已启动阶段 1（工程骨架与模块拆分）。
2. 已完成门户壳层从 `index.html` 内联样式/脚本拆分到 `src/portal/`。
3. 已完成首批模块化拆分：`config.js`、`utils.js`、`app.js`、`styles.css`。
4. 已补充重构日志：`docs/refactor-log.md`（持续记录）。
5. 已继续拆分：`state/dom/services/routing/catalog/preview` 模块落地。
6. 已完成工程化骨架：`package.json`、`tsconfig.json`、`vite.config.js`（`typecheck/build` 可执行）。
7. 已继续拆分 `init/事件`：`features/bootstrap` 模块落地，`app.js` 降为装配层。
8. 已补充质量门禁：`eslint`、`prettier`、`vitest` 与 `quality.yml`（含 test）。
9. 已补齐阶段 2 关键项：`projects.schema.json` 与 `tools/validate-projects.mjs`（CI 已接入）。
10. 已新增阶段 6 文档：`docs/project-onboarding.md`、`docs/troubleshooting.md`。
11. 已补齐阶段 0 交付物：`docs/baseline-checklist.md`、`docs/rollback.md`。
12. 已补充单元测试：`routing`、`manifest-service`、`utils`。
13. 已完成 TypeScript 渐进迁移首批：`services` 与 `routing/utils` 接入 `@ts-check + JSDoc`。
14. 已新增 `typecheck:services` 并接入 `quality` 流水线。
15. 已完成 TypeScript 渐进迁移第二批：`features` 与 `app/state/dom/config` 接入 `@ts-check + JSDoc`。
16. 已新增统一类型定义 `src/portal/types.js`，并将严格类型检查扩展到 `src/portal/**/*.js`（`typecheck:portal`）。
17. 已完成样式分层：`styles.css` 拆分为 `tokens/base/layout/components` 四层文件。
18. 已推进阶段 3 异常兜底：新增 iframe 预览状态提示（加载中/跨域不可同步/重定向不匹配/加载失败）。
19. 已推进阶段 5：接入 Playwright 配置与门户 E2E 基线用例（目录渲染、搜索、深链恢复、iframe 失败提示）。
20. 已将 E2E 步骤接入 `quality.yml`（安装 Chromium 后执行 `npm run test:e2e`）。
21. 已推进阶段 2 协议增强：`projects.manifest.json` 升级为 `version: 3`，新增 `projects` 平铺结构与项目元字段（`id/member/routeMode/...`）。
22. 已启用 `project.meta.json`：支持 `entry/routeMode/displayName/order/hiddenPages/tags/updatedAt` 自动入清单。
23. 门户读取策略升级为“manifest 优先、GitHub API 兜底”，并支持 `displayName/routeMode/hiddenPages`。
24. 已完成质量脚本分层：本地 `quality`（不含 E2E）与 CI `quality:ci`（含 E2E）拆分。
25. 已修复深链恢复与“新窗口打开”行为：复制链接在新标签页可直接定位目标页面，不再回到首页。
26. 下一步补齐阶段 3 异常回归覆盖与阶段 6 多技术栈样例验证。

## 1. 背景与目标

### 1.1 背景问题

当前项目已具备核心能力，但工程层面存在以下问题：

1. `index.html` 集中承载样式、业务逻辑、路由与数据读取，耦合高，后续功能扩展风险大。
2. `scripts/generate_manifest.py` 在生成清单时会改写构建产物，属于补丁式策略，难以长期维护。
3. 对多技术栈项目（Vue/React/纯静态等）缺少统一接入协议，只能依赖运行时兜底。
4. 缺少稳定的工程质量门禁（类型检查、测试、CI校验、可发布流程）。

### 1.2 重构目标

1. 保持核心功能不变：团队静态页面统一托管，目录页通过 `iframe` 预览。
2. 每个页面必须有可直接访问的 URL，目录页也可通过 URL 精准定位到目标页面。
3. 兼容不同技术栈构建产物，统一接入标准，避免自动“修补产物”。
4. 设计风格简洁、实用、现代，视觉方向贴近 Apple 风格。
5. 架构可维护、可扩展、可测试，杜绝临时补丁方案。
6. 成员接入做到零配置：只新增目录并上传文件，不手工修改任何配置文件。

### 1.3 非目标

1. 不修改业务页面内部功能与视觉，仅改造门户壳层与接入方式。
2. 不对成员项目源码做侵入式改造。
3. 不引入重型后端服务，保持 GitHub Pages 纯静态部署。

### 1.4 零配置接入原则

1. 成员只做两件事：新建 `成员/项目` 目录并上传静态文件。
2. `projects.manifest.json` 等索引配置由仓库自动扫描生成。
3. 不要求成员手动维护 `project.meta.json`、入口映射或路由映射。
4. 所有生成动作在 CI 自动执行，人工仅在异常时处理告警。

## 2. 总体技术方案

### 2.1 技术选型

1. 门户壳层：`Vite + TypeScript (strict) + 原生 DOM 模块化`。
2. 样式体系：`CSS Variables + Design Tokens`，组件化样式分层。
3. 质量体系：`ESLint + Prettier + Vitest + Playwright + GitHub Actions`。
4. 数据源：`projects.manifest.json`（CI 自动生成）+ GitHub API（可选兜底，不阻塞主流程）。

### 2.2 路由与 URL 规范

1. 页面直达 URL：`/{成员}/{项目}/{文件}.html`。
2. 门户定位 URL：`/#/view/{encodedFilePath}`。
3. 门户定位 + 子路由 URL：`/#/view/{encodedFilePath}?r={encodedSubRoute}`。
4. 门户统一使用 Hash Router，避免 GitHub Pages 无服务端重写导致的 404。

### 2.3 目录结构（目标）

```text
/
  index.html
  projects.manifest.json
  projects.schema.json
  方案.md
  README.md
  tools/
    generate-manifest.ts
    validate-projects.ts
  src/
    portal/
      app.ts
      router.ts
      config.ts
      state/
        store.ts
      services/
        manifest-service.ts
      features/
        catalog/
          catalog-controller.ts
          catalog-renderer.ts
        preview/
          preview-controller.ts
        search/
          search-controller.ts
      styles/
        tokens.css
        base.css
        layout.css
        components.css
  .github/
    workflows/
      pages.yml
      quality.yml
```

## 3. 接入协议设计（替代补丁）

### 3.1 Manifest 协议

`projects.manifest.json` 增强为统一协议，推荐字段：

1. `generatedAt`: 生成时间。
2. `version`: 协议版本。
3. `projects`: 项目数组。
4. 项目字段：
   - `id`: 唯一标识，建议 `成员/项目`。
   - `member`: 成员名。
   - `name`: 项目名。
   - `entry`: 入口 HTML 相对路径。
   - `pages`: 可预览页面列表。
   - `routeMode`: `path` 或 `hash`。
   - `tags`: 可选标签。
   - `updatedAt`: 最近更新时间（可选）。

### 3.2 项目级可选元数据

每个项目目录可选放置 `project.meta.json`，仅用于高级定制，不作为接入前置条件：

1. `entry`: 明确入口页。
2. `routeMode`: 该项目子路由解析方式。
3. `displayName`: 门户展示名称。
4. `order`: 排序权重。
5. `hiddenPages`: 需要在目录中隐藏但可直达的页面。
6. 默认情况下不需要该文件，系统会自动推断入口和页面列表。

### 3.3 兼容性原则

1. 对可确定且可验证的静态资源根绝对路径执行自动改写（改为相对路径）。
2. 对无法安全自动修复的问题在 CI 阶段阻断，防止带病上线。
3. 校验失败必须给出明确错误位置和修复建议。

## 4. 分阶段实施计划（详细步骤）

## 阶段 0：基线冻结与风险隔离

目标：在改造前固定当前行为，确保可回归验证。

步骤：

1. 创建 `refactor/base-architecture` 分支。
2. 记录当前 `index.html` 功能清单：
   - 左侧目录树渲染。
   - 搜索成员。
   - 全部展开/折叠。
   - iframe 预览。
   - URL hash 同步与刷新恢复。
   - 新窗口打开。
3. 产出基线测试用例文档（手工 + 自动化待补）。
4. 添加回滚说明：一键切回旧版 `index.html` 发布方式。

交付物：

1. `docs/baseline-checklist.md`
2. `docs/rollback.md`

验收标准：

1. 基线功能清单覆盖率 100%。
2. 回滚步骤在本地演练可执行。

## 阶段 1：工程骨架与模块拆分

目标：在不改功能行为前提下，把单文件改为可维护模块。

步骤：

1. 初始化前端工程：
   - 新增 `package.json`。
   - 安装 `vite`、`typescript`、`eslint`、`prettier`。
   - 配置 `tsconfig.json`（`strict: true`）。
2. 创建门户入口：
   - `src/portal/app.ts` 作为唯一启动点。
   - `index.html` 仅保留容器与资源引入。
3. 拆分功能模块：
   - `router.ts` 负责 URL 解析与同步。
   - `manifest-service.ts` 负责清单读取与错误处理。
   - `catalog-*` 负责目录树构建和渲染。
   - `preview-controller.ts` 负责 iframe 行为与状态联动。
4. 建立状态管理：
   - `state/store.ts` 统一管理 activePath、searchKeyword 等状态。
   - 禁止跨模块直接改 DOM 状态。
5. 搭建样式层次：
   - `tokens.css`：颜色、圆角、间距、阴影、字体。
   - `base.css`：Reset 与通用基础样式。
   - `layout.css`：整体布局。
   - `components.css`：目录树、按钮、面板等组件。

交付物：

1. 模块化代码结构上线。
2. 行为与旧版一致的门户页面。

验收标准：

1. 功能与旧版逐项对齐，无回归。
2. TypeScript 编译无错误。
3. `eslint` 与 `prettier` 全量通过。

## 阶段 2：Manifest 重建与协议化

目标：替换补丁式脚本，建立稳定的“扫描 + 校验 + 输出”流程。

步骤：

1. 新建 `tools/generate-manifest.ts`：
   - 扫描 `成员/项目/*.html`。
   - 自动推断默认入口（优先 `index.html`）。
   - 自动修正多页面静态资源的根绝对路径为相对路径（按当前文件目录计算）。
   - 自动生成成员树、项目树、入口与统计字段。
   - 仅在存在 `project.meta.json` 时读取增强配置（默认不需要）。
   - 产出新版 `projects.manifest.json`。
2. 新建 CI 自动生成流程（GitHub Actions）：
   - `main` 分支有提交时自动执行 manifest 生成。
   - 如清单有变化自动提交，无需人工改配置文件。
   - 确保“新增目录并上传文件”即可生效。
3. 新建 `projects.schema.json`：
   - 定义 manifest JSON schema。
   - 在 CI 中验证结构合法性。
4. 新建 `tools/validate-projects.ts`：
   - 校验入口页是否存在。
   - 校验页面文件列表可达。
   - 扫描绝对路径资源引用并给出告警/失败。
   - 校验常见 SPA 构建配置风险（非阻塞项可设 warning）。
5. 保留并增强 `scripts/generate_manifest.py` 的安全改写能力：
   - 仅处理可验证存在的绝对静态资源路径（HTML/CSS）。
   - 改写策略保持可追踪、可回滚、可审计。

交付物：

1. 新版 manifest 生成器与校验器。
2. JSON schema 与验证流程。

验收标准：

1. `npm run manifest:generate` 可稳定生成。
2. `npm run manifest:validate` 对异常给出精确报错。
3. 新增成员/项目后无需手工改任何配置文件即可上线。
4. 仅对可验证的绝对静态资源路径执行自动改写，其余文件不做盲改。

## 阶段 3：路由与 iframe 深链稳定化

目标：保证“每页面可直达 + 门户可恢复 + iframe 同步可靠”。

步骤：

1. 设计统一路由模型：
   - `viewPath`：目标 HTML 路径。
   - `subRoute`：页面内二级路由信息。
2. 实现 URL 编解码器：
   - 统一处理中文目录、空格、特殊字符。
   - 保证刷新与分享 URL 一致可还原。
3. 实现 iframe 同步策略：
   - 目录点击驱动 iframe。
   - iframe load 事件回写 URL。
   - hashchange 与 load 避免循环触发。
4. 完善异常处理：
   - 404 页面不存在。
   - iframe 拒绝加载（X-Frame-Options/CSP）。
   - 跨域或路径不匹配时给出用户提示。

交付物：

1. 稳定可分享的深链 URL 系统。
2. iframe 同步逻辑与异常兜底页面。

验收标准：

1. 任意页面 URL 可复制分享并直接打开。
2. 刷新、前进后退行为正确。
3. 不出现 hash 抖动、死循环加载。

## 阶段 4：Apple 风格 UI 重构

目标：在保持实用的前提下，统一简洁现代视觉语言。

步骤：

1. 定义设计令牌：
   - 色板：中性灰阶 + 低饱和强调色。
   - 圆角：8/12/16。
   - 阴影：轻层级，避免厚重投影。
   - 间距系统：8pt 节奏。
2. 布局重构：
   - 侧栏固定宽度 + 主区弹性。
   - 移动端改为上下结构，侧栏可折叠。
3. 组件重绘：
   - 搜索框、按钮、目录节点、空态、提示条。
   - 统一交互动效（hover/focus/active），时长 120~200ms。
4. 可访问性优化：
   - 键盘导航。
   - 对比度与焦点态可见。
   - iframe 标题、按钮 aria 标签补齐。

交付物：

1. 新视觉主题与组件样式。
2. 移动端和桌面端统一体验。

验收标准：

1. 页面风格统一且无视觉断裂。
2. 主要交互均可键盘操作。
3. 在常见分辨率下无布局错位。

## 阶段 5：测试体系与质量门禁

目标：建立“可持续迭代”的质量保障。

步骤：

1. 单元测试（Vitest）：
   - 路由编解码器。
   - 入口文件选择算法。
   - manifest 数据转换函数。
2. 端到端测试（Playwright）：
   - 目录树渲染。
   - 搜索过滤。
   - iframe 预览打开。
   - URL 恢复与分享。
3. 质量脚本：
   - `npm run lint`
   - `npm run typecheck`
   - `npm run test`
   - `npm run test:e2e`
4. GitHub Actions：
   - PR 触发质量流水线。
   - 主分支合并后自动构建与 Pages 发布。

交付物：

1. 自动化测试与 CI 配置。
2. 质量门禁文档。

验收标准：

1. PR 合并前必须通过所有检查。
2. 发布流程自动化且可追踪。

## 阶段 6：团队迁移与规范落地

目标：让团队成员低成本接入，减少重复沟通。

步骤：

1. 更新 `README.md`：
   - 新目录规范。
   - “零配置接入”说明（只上传目录与文件）。
   - manifest 自动生成机制说明。
   - 常见构建配置建议（Vite/Vue/React）。
2. 新增 `docs/project-onboarding.md`：
   - 新成员接入流程。
   - 可选高级配置（如 `project.meta.json`）说明。
   - 常见错误对照表。
3. 新增 `docs/troubleshooting.md`：
   - 白屏问题排查。
   - 资源 404 排查。
   - iframe 拒绝加载排查。
4. 组织一次迁移验证：
   - 随机抽取至少 3 类项目（纯静态、Vue、React）演练。

交付物：

1. 完整文档体系。
2. 已验证的多技术栈接入样例。

验收标准：

1. 新成员按文档可独立接入。
2. 样例项目接入成功率 100%。

## 阶段 7：发布、回滚与持续优化

目标：平滑上线并形成长期维护节奏。

步骤：

1. 小流量灰度：
   - 先在分支 Pages 或临时域名验证。
2. 正式切换：
   - 主分支部署新门户。
   - 观察首日错误日志与 issue。
3. 回滚预案：
   - 保留旧版构建产物标签。
   - 如出现阻断问题，5 分钟内可回滚。
4. 持续优化节奏：
   - 双周评审接入问题与新增需求。
   - 每月一次技术债盘点与清理。

交付物：

1. 发布记录与回滚记录模板。
2. 持续改进任务池。

验收标准：

1. 上线后一周内无 P1/P0 故障。
2. 回滚演练可执行且验证通过。

## 5. 任务清单（执行视图）

### 5.1 核心里程碑

1. M1：模块化门户壳层完成，功能全等。
2. M2：manifest 协议化完成，非安全补丁逻辑下线，安全路径改写保留。
3. M3：深链路由稳定，URL 可分享可恢复。
4. M4：UI 与测试体系完成，上线发布。

### 5.2 建议排期（可按人力调整）

1. 第 1 周：阶段 0、1。
2. 第 2 周：阶段 2、3。
3. 第 3 周：阶段 4、5。
4. 第 4 周：阶段 6、7 与正式上线。

## 6. 风险与应对

1. 风险：部分历史项目资源路径不规范导致白屏。
   - 应对：CI 提前校验并给出修复指南，不在运行时偷偷修补。
2. 风险：不同框架路由策略不统一导致深链异常。
   - 应对：使用 `routeMode` 协议声明，门户按项目策略解析。
3. 风险：中文路径与特殊字符导致 URL 解码错误。
   - 应对：统一编解码工具函数并补齐单测。
4. 风险：重构期间功能回归。
   - 应对：基线清单 + E2E 用例 + 阶段性验收。

## 7. 完成定义（Definition of Done）

当以下条件全部满足时，认定重构完成：

1. 核心功能全等且体验提升。
2. 每个页面都可通过独立 URL 直达。
3. 目录页 `iframe` 预览稳定，分享链接可恢复。
4. 已移除不可控补丁改写，保留可验证的静态资源路径自动改写 + 协议化校验。
5. CI 质量门禁生效，文档完整可用。
